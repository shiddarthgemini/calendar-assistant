<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem;
        }
        .input-group {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .form-control {
            border: none;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 1rem 2rem;
            border-radius: 0 15px 15px 0;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .event-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
            transition: transform 0.3s ease;
        }
        .event-card:hover {
            transform: translateY(-5px);
        }
        .loading {
            display: none;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        .alert {
            border-radius: 15px;
            border: none;
        }
        .examples {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .example-item {
            background: white;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .example-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        .duration-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .duration-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="main-container">
                    <!-- Header -->
                    <div class="header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-center flex-grow-1">
                                <h1><i class="fas fa-calendar-alt me-3"></i>Calendar Assistant</h1>
                                <p class="mb-0">Create events with natural language using AI</p>
                            </div>
                            <div class="user-info">
                                {% if user_info %}
                                    <div class="dropdown">
                                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-user me-2"></i>{{ user_info.name }}
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                            <li><a class="dropdown-item" href="{{ url_for('profile') }}">
                                                <i class="fas fa-user-circle me-2"></i>Profile
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                                            </a></li>
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="p-4">
                        <!-- Flash Messages -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <!-- Input Form -->
                        <div class="mb-4">
                            <form id="eventForm">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="promptInput" 
                                           placeholder="e.g., 'team meeting tomorrow at 3pm' or 'call with John in 2 hours'"
                                           required>
                                    <button type="submit" class="btn btn-primary">
                                        <span class="btn-text">
                                            <i class="fas fa-plus me-2"></i>Add Event
                                        </span>
                                        <span class="loading">
                                            <span class="spinner-border spinner-border-sm me-2"></span>Creating...
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Examples -->
                        <div class="examples">
                            <h5><i class="fas fa-lightbulb me-2"></i>Try these examples:</h5>
                            <div class="example-item" onclick="useExample('team meeting tomorrow at 3pm')">
                                <i class="fas fa-users me-2"></i>team meeting tomorrow at 3pm
                            </div>
                            <div class="example-item" onclick="useExample('doctor appointment on Friday 2pm for 30 minutes')">
                                <i class="fas fa-user-md me-2"></i>doctor appointment on Friday 2pm for 30 minutes
                            </div>
                            <div class="example-item" onclick="useExample('call with John in 2 hours')">
                                <i class="fas fa-phone me-2"></i>call with John in 2 hours
                            </div>
                            <div class="example-item" onclick="useExample('lunch meeting next Monday at noon')">
                                <i class="fas fa-utensils me-2"></i>lunch meeting next Monday at noon
                            </div>
                        </div>
                        
                        <!-- Debug Test Button -->
                        <div class="mb-3">
                            <button class="btn btn-warning" onclick="testModal()">
                                <i class="fas fa-bug me-2"></i>Test Modal (Debug)
                            </button>
                        </div>

                        <!-- Results -->
                        <div id="results"></div>

                        <!-- Events List -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-list me-2"></i>Upcoming Events</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadEvents()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                            </div>
                            <div id="eventsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="duration-modal">
        <div class="duration-content">
            <h5><i class="fas fa-check-circle me-2 text-success"></i>Confirm Event</h5>
            <div class="mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title" id="confirmTitle"></h6>
                        <p class="card-text">
                            <i class="fas fa-calendar me-2"></i><span id="confirmDateTime"></span><br>
                            <i class="fas fa-clock me-2"></i><span id="confirmDuration"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="confirmEvent()">
                    <i class="fas fa-check me-2"></i>Create Event
                </button>
                <button class="btn btn-secondary" onclick="closeConfirmationModal()">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Duration Modal -->
    <div id="durationModal" class="duration-modal">
        <div class="duration-content">
            <h5><i class="fas fa-clock me-2"></i>Event Duration</h5>
            <p>How long should this event be?</p>
            <div class="mb-3">
                <input type="text" class="form-control" id="durationInput" 
                       placeholder="e.g., 30, 60, 90 minutes or 1 hour">
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="quickDuration(30)">30 min</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="quickDuration(60)">1 hour</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="quickDuration(90)">1.5 hours</button>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="submitDuration()">Continue</button>
                <button class="btn btn-secondary ms-2" onclick="closeDurationModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Follow-up Questions Modal -->
    <div id="followupModal" class="duration-modal">
        <div class="duration-content">
            <h5><i class="fas fa-question-circle me-2"></i>Additional Details Needed</h5>
            <div id="followupQuestions" class="mb-3">
                <!-- Questions will be populated here -->
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="followupInput" 
                       placeholder="Enter your response...">
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="submitFollowup()">Submit</button>
                <button class="btn btn-secondary ms-2" onclick="closeFollowupModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEventData = null;
        let pendingEventData = null;
        let chatContext = [];
        let followupData = null;

        // Use example
        function useExample(text) {
            document.getElementById('promptInput').value = text;
        }
        
        // Test modal function
        function testModal() {
            console.log('[DEBUG] Testing modal manually...');
            showFollowupModal(
                ["What's the duration?", "Where is the meeting?"],
                {
                    title: "Test Event",
                    date_time: "2025-08-07T15:00:00",
                    duration_minutes: null,
                    location: null,
                    description: "A test event",
                    needs_followup: true,
                    followup_questions: ["What's the duration?", "Where is the meeting?"]
                }
            );
        }

        // Load events
        function loadEvents() {
            fetch('/list_events')
                .then(response => {
                    if (response.status === 401) {
                        // Redirect to login page if not authenticated
                        window.location.href = '/login';
                        return;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Already redirected
                    if (data.success) {
                        displayEvents(data.events);
                    } else {
                        showAlert('Error loading events: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                    showAlert('Error loading events: ' + error, 'danger');
                });
        }

        // Display events
        function displayEvents(events) {
            const eventsList = document.getElementById('eventsList');
            if (events.length === 0) {
                eventsList.innerHTML = '<div class="text-center text-muted py-4">No upcoming events found</div>';
                return;
            }

            eventsList.innerHTML = events.map(event => `
                <div class="event-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${event.summary}</h6>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-2"></i>${event.start_time}
                            </p>
                        </div>
                        <a href="${event.link}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Show alert
        function showAlert(message, type) {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Show confirmation modal
        function showConfirmationModal(title, startTime, duration) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmDateTime').textContent = startTime;
            document.getElementById('confirmDuration').textContent = duration + ' minutes';
            document.getElementById('confirmationModal').style.display = 'block';
        }

        // Close confirmation modal
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            pendingEventData = null;
        }

        // Show duration modal
        function showDurationModal() {
            document.getElementById('durationModal').style.display = 'block';
            document.getElementById('durationInput').focus();
        }

        // Close duration modal
        function closeDurationModal() {
            document.getElementById('durationModal').style.display = 'none';
            currentEventData = null;
        }

        // Show follow-up modal
        function showFollowupModal(questions, parsedData) {
            console.log('[DEBUG] showFollowupModal called with:', { questions, parsedData });
            followupData = parsedData;
            currentEventData = {
                title: parsedData.title,
                start_time: parsedData.date_time,
                original_prompt: document.getElementById('promptInput').value
            };
            const questionsDiv = document.getElementById('followupQuestions');
            questionsDiv.innerHTML = questions.map(q => `<p class="mb-2"><i class="fas fa-question me-2"></i>${q}</p>`).join('');
            const modal = document.getElementById('followupModal');
            modal.style.display = 'block';
            console.log('[DEBUG] Modal display style set to:', modal.style.display);
            
            // Force the modal to be visible and on top
            modal.style.zIndex = '9999';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            console.log('[DEBUG] Modal should now be visible');
            document.getElementById('followupInput').focus();
        }

        // Close follow-up modal
        function closeFollowupModal() {
            document.getElementById('followupModal').style.display = 'none';
            followupData = null;
        }

        // Submit follow-up response
        function submitFollowup() {
            const response = document.getElementById('followupInput').value.trim();
            if (!response) {
                showAlert('Please enter a response', 'warning');
                return;
            }

            showLoading();
            closeFollowupModal();

            // Add follow-up response to chat context
            chatContext.push({
                role: 'assistant',
                content: 'Please provide additional details: ' + followupData.followup_questions.join(', ')
            });
            chatContext.push({
                role: 'user',
                content: response
            });

            fetch('/add_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: '', // Original prompt is in parsed_data
                    followup_response: response,
                    original_parsed_data: followupData,
                    chat_context: chatContext
                })
            })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data) return;
                if (data.success) {
                    showAlert(`
                        <strong>✅ Event Created!</strong><br>
                        <strong>${data.title}</strong><br>
                        📅 ${data.start_time}<br>
                        ⏱️ ${data.duration}<br>
                        📍 ${data.location}<br>
                        📝 ${data.description || 'No description'}<br>
                        <a href="${data.link || 'https://calendar.google.com'}" target="_blank" class="btn btn-sm btn-primary mt-2">
                            <i class="fas fa-external-link-alt me-1"></i>View in Calendar
                        </a>
                    `, 'success');
                    loadEvents();
                    chatContext = [];
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error: ' + error, 'danger');
            })
            .finally(() => {
                hideLoading();
                document.getElementById('followupInput').value = '';
            });
        }

        // Quick duration selection
        function quickDuration(minutes) {
            document.getElementById('durationInput').value = minutes;
        }

        // Submit duration
        function submitDuration() {
            const durationInput = document.getElementById('durationInput').value.trim();
            if (!durationInput) {
                showAlert('Please enter a duration', 'warning');
                return;
            }

            // Parse duration input
            let durationMinutes = 60; // default
            if (durationInput.toLowerCase().includes('hour')) {
                if (durationInput.includes('1.5')) {
                    durationMinutes = 90;
                } else {
                    durationMinutes = 60;
                }
            } else {
                try {
                    durationMinutes = parseInt(durationInput);
                } catch (e) {
                    durationMinutes = 60;
                }
            }

            closeDurationModal();
            // Show confirmation modal instead of creating event directly
            if (currentEventData) {
                pendingEventData = {
                    title: currentEventData.title,
                    start_time: currentEventData.start_time,
                    duration: durationMinutes,
                    original_prompt: currentEventData.original_prompt
                };
                showConfirmationModal(
                    currentEventData.title,
                    currentEventData.start_time,
                    durationMinutes
                );
            }
        }

        // Confirm and create event
        function confirmEvent() {
            if (!pendingEventData) return;

            showLoading();
            closeConfirmationModal();

            // Create the event with the confirmed details
            fetch('/add_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: pendingEventData.original_prompt,
                    duration_minutes: pendingEventData.duration,
                    chat_context: chatContext
                })
            })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data) return;
                if (data.success) {
                    showAlert(`
                        <strong>✅ Event Created!</strong><br>
                        <strong>${data.title}</strong><br>
                        📅 ${data.start_time}<br>
                        ⏱️ ${data.duration}<br>
                        📍 ${data.location}<br>
                        📝 ${data.description || 'No description'}<br>
                        <a href="${data.link || 'https://calendar.google.com'}" target="_blank" class="btn btn-sm btn-primary mt-2">
                            <i class="fas fa-external-link-alt me-1"></i>View in Calendar
                        </a>
                    `, 'success');
                    loadEvents();
                    chatContext = [];
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error: ' + error, 'danger');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // Create event with duration (legacy function) - REMOVED TO PREVENT DUPLICATE CALLS
        // This function is no longer needed as confirmEvent() handles all event creation

        // Show loading
        function showLoading() {
            document.querySelector('.btn-text').style.display = 'none';
            document.querySelector('.loading').style.display = 'inline-block';
        }

        // Hide loading
        function hideLoading() {
            document.querySelector('.btn-text').style.display = 'inline-block';
            document.querySelector('.loading').style.display = 'none';
        }

        // Handle form submission
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) return;

            showLoading();
            showAlert('', ''); // Clear previous alerts

            // Add to chat context
            chatContext.push({
                role: 'user',
                content: prompt
            });

            console.log('[DEBUG] Making API call to /add_event with prompt:', prompt);
            fetch('/add_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    prompt: prompt,
                    chat_context: chatContext
                })
            })
            .then(response => {
                if (response.status === 401) {
                    // Redirect to login page if not authenticated
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[DEBUG] Received response:', data);
                if (!data) return; // Already redirected
                if (data.needs_followup) {
                    console.log('[DEBUG] Showing follow-up modal with questions:', data.followup_questions);
                    // Show follow-up questions modal
                    showFollowupModal(data.followup_questions, data.parsed_data);
                } else if (data.success) {
                    // Event was already created by the MCP function, show success message
                    showAlert(`
                        <strong>✅ Event Created!</strong><br>
                        <strong>${data.title}</strong><br>
                        📅 ${data.start_time}<br>
                        ⏱️ ${data.duration}<br>
                        📍 ${data.location}<br>
                        📝 ${data.description || 'No description'}<br>
                        <a href="${data.link || 'https://calendar.google.com'}" target="_blank" class="btn btn-sm btn-primary mt-2">
                            <i class="fas fa-external-link-alt me-1"></i>View in Calendar
                        </a>
                    `, 'success');
                    loadEvents();
                    // Clear chat context after successful event creation
                    chatContext = [];
                } else {
                    showAlert('Error: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error: ' + error, 'danger');
            })
            .finally(() => {
                hideLoading();
                document.getElementById('promptInput').value = '';
            });
        });

        // Close modals when clicking outside
        document.getElementById('durationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDurationModal();
            }
        });

        document.getElementById('confirmationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmationModal();
            }
        });

        document.getElementById('followupModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFollowupModal();
            }
        });

        // Enter key in duration input
        document.getElementById('durationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitDuration();
            }
        });

        // Enter key in follow-up input
        document.getElementById('followupInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitFollowup();
            }
        });

        // Load events on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadEvents();
        });
    </script>
</body>
</html> 